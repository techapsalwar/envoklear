name: Deploy to Hostinger

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, bcmath
          coverage: none
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-interaction --no-dev --optimize-autoloader
        
      - name: Install NPM dependencies
        run: npm ci
        
      - name: Build assets
        run: npm run build
        
      - name: Deploy to Hostinger via SSH/Rsync
        uses: easingthemes/ssh-deploy@v5.0.3
        with:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_HOST: ${{ secrets.HOSTING_IP }}
          REMOTE_USER: ${{ secrets.HOSTING_USER }}
          REMOTE_PORT: ${{ secrets.HOSTING_PORT }}
          SOURCE: "./"
          TARGET: ${{ secrets.TARGET_DIR }}
          ARGS: "-rlgoDzvc -i --delete"
          EXCLUDE: "/node_modules/, /.git/, /.github/, /tests/, /storage/logs/, /.env, /vendor/"
          SCRIPT_BEFORE: |
            whoami
            ls -al
          SCRIPT_AFTER: |
            cd ${{ secrets.TARGET_DIR }}
            
            # Fix Laravel directory structure for Hostinger
            if [ -d "public" ] && [ ! -f "index.php" ]; then
              echo "üìÅ Copying public folder contents to root..."
              cp -r public/* ./
              cp public/.htaccess ./ 2>/dev/null || true
              
              echo "üìù Updating index.php paths..."
              sed -i "s|__DIR__.'/../vendor/autoload.php'|__DIR__.'/vendor/autoload.php'|g" index.php
              sed -i "s|__DIR__.'/../bootstrap/app.php'|__DIR__.'/bootstrap/app.php'|g" index.php
            fi
            
            # Ensure .env exists and has APP_KEY
            if [ ! -f ".env" ]; then
              echo "‚ö†Ô∏è  .env not found, creating from example..."
              cp .env.example .env
            fi
            
            # Generate APP_KEY if missing
            if ! grep -q "APP_KEY=base64:" .env; then
              echo "üîë Generating APP_KEY..."
              php artisan key:generate --force
            fi
            
            # Install dependencies and setup
            composer install --no-dev --optimize-autoloader --no-interaction
            
            # Set correct permissions
            chmod -R 755 storage bootstrap/cache
            chmod 644 index.php 2>/dev/null || true
            chmod 644 .htaccess 2>/dev/null || true
            find storage -type f -exec chmod 644 {} \; 2>/dev/null || true
            find bootstrap/cache -type f -exec chmod 644 {} \; 2>/dev/null || true
            
            # Clear and cache
            php artisan config:clear
            php artisan cache:clear
            php artisan route:clear
            php artisan view:clear
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan migrate --force
            php artisan storage:link
            
            echo "‚úÖ Deployment complete!"
            
      - name: Deployment Status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "‚úÖ Deployment completed successfully!"
          else
            echo "‚ùå Deployment failed!"
          fi
